<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnchorStage v2.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"
    }
  }
  </script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #e5e5e5; overflow: hidden; height: 100vh; user-select: none; }

    /* Upload overlay */
    #upload-screen { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: #0a0a0a; transition: opacity 0.4s; }
    #upload-screen.hidden { opacity: 0; pointer-events: none; }
    .upload-zone { width: 560px; text-align: center; }
    .upload-zone .drop-area { border: 2px dashed #333; border-radius: 16px; padding: 60px 40px; transition: border-color 0.2s, background 0.2s; cursor: pointer; }
    .upload-zone .drop-area:hover, .upload-zone .drop-area.dragover { border-color: #c4a35a; background: rgba(196,163,90,0.05); }
    .upload-zone h2 { font-size: 22px; font-weight: 600; margin-bottom: 8px; color: #fff; }
    .upload-zone p { font-size: 13px; color: #666; margin-bottom: 20px; }
    .upload-zone .or { color: #444; font-size: 12px; margin: 16px 0; }
    .upload-btn { background: #c4a35a; color: #0a0a0a; border: none; padding: 10px 28px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .upload-btn:hover { background: #d4b36a; }
    .upload-btn:disabled { opacity: 0.5; cursor: wait; }
    .synth-link { color: #555; font-size: 12px; margin-top: 16px; cursor: pointer; text-decoration: underline; }
    .synth-link:hover { color: #888; }

    /* Loading overlay */
    #loading-overlay { position: fixed; inset: 0; z-index: 90; background: rgba(10,10,10,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
    #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loader { width: 40px; height: 40px; border: 3px solid #222; border-top-color: #c4a35a; border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Main app layout */
    #app { display: flex; flex-direction: column; height: 100vh; }

    /* Top bar */
    .top-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px 20px; background: #111; border-bottom: 1px solid #1a1a1a; height: 44px; flex-shrink: 0; z-index: 20; position: relative; }
    .brand { display: flex; align-items: center; gap: 8px; }
    .brand-mark { width: 26px; height: 26px; background: #c4a35a; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: #0a0a0a; }
    .brand-text { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
    .brand-text span { color: #c4a35a; }
    .top-subtitle { font-size: 12px; color: #555; margin-left: 12px; }
    .top-stats { display: flex; gap: 16px; font-size: 11px; color: #555; }

    /* Middle: viewport + photos sidebar */
    .middle { flex: 1; display: flex; overflow: hidden; position: relative; }

    /* 3D viewport container */
    .viewport-wrap { flex: 1; position: relative; background: #000; }
    #viewer-container { width: 100%; height: 100%; }
    #viewer-container canvas { display: block; width: 100% !important; height: 100% !important; }
    .hud-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
    .hud-overlay > * { pointer-events: auto; }

    /* Capture button */
    .capture-btn { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); border: 1px solid #333; border-radius: 8px; padding: 6px 14px; font-size: 12px; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: background 0.2s; }
    .capture-btn:hover { background: rgba(196,163,90,0.3); border-color: #c4a35a; }

    /* Lens HUD */
    .lens-hud { position: absolute; bottom: 16px; left: 20px; display: flex; align-items: center; gap: 8px; }
    .lens-label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .lens-group { display: flex; gap: 2px; }
    .lens-btn { background: transparent; border: 1px solid #333; color: #888; padding: 4px 10px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; border-radius: 4px; }
    .lens-btn:hover { border-color: #555; color: #ccc; }
    .lens-btn.active { background: rgba(255,255,255,0.12); border-color: #888; color: #fff; }

    /* Sensitivity HUD */
    .sensitivity-hud { position: absolute; bottom: 16px; right: 20px; display: flex; align-items: center; gap: 8px; font-size: 11px; color: #666; }
    .sensitivity-hud input { width: 80px; accent-color: #c4a35a; }

    /* Camera position HUD */
    .cam-hud { position: absolute; top: 12px; left: 16px; font-size: 11px; color: rgba(255,255,255,0.5); font-family: 'Inter', monospace; line-height: 1.6; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }

    /* Crosshair */
    .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); pointer-events: none !important; }
    .crosshair::before, .crosshair::after { content: ''; position: absolute; background: rgba(255,255,255,0.25); border-radius: 1px; }
    .crosshair::before { width: 20px; height: 2px; left: -10px; top: -1px; }
    .crosshair::after { width: 2px; height: 20px; left: -1px; top: -10px; }

    /* Photos sidebar */
    .photos-sidebar { width: 180px; background: #0f0f0f; border-left: 1px solid #1a1a1a; padding: 12px; overflow-y: auto; flex-shrink: 0; z-index: 20; }
    .photos-title { font-size: 13px; font-weight: 600; color: #888; margin-bottom: 10px; }
    .photo-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 6px; margin-bottom: 8px; border: 2px solid transparent; cursor: pointer; transition: border-color 0.15s; }
    .photo-thumb:hover { border-color: #c4a35a; }
    .photos-empty { font-size: 11px; color: #444; text-align: center; padding: 20px 0; }

    /* Bottom shortcut bar */
    .shortcut-bar { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 6px 20px; background: #0f0f0f; border-top: 1px solid #1a1a1a; height: 34px; flex-shrink: 0; z-index: 20; }
    .shortcut { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #555; }
    .shortcut kbd { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 3px; padding: 1px 5px; font-size: 10px; color: #888; font-family: 'Inter', monospace; }

    /* FPS counter */
    .fps-display { position: absolute; top: 12px; right: 200px; font-size: 11px; color: rgba(255,255,255,0.4); font-family: monospace; }
  </style>
</head>
<body>

  <!-- Upload Screen -->
  <div id="upload-screen">
    <div class="upload-zone">
      <div class="drop-area" id="drop-area">
        <svg width="48" height="48" fill="none" stroke="#444" stroke-width="1.5" viewBox="0 0 24 24" style="margin:0 auto 16px"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M3.75 21h16.5A2.25 2.25 0 0022.5 18.75V5.25A2.25 2.25 0 0020.25 3H3.75A2.25 2.25 0 001.5 5.25v13.5A2.25 2.25 0 003.75 21z"/></svg>
        <h2>Explore your set</h2>
        <p>Drop an image here to reconstruct a navigable 3D scene</p>
        <div class="or">or</div>
        <button class="upload-btn" id="upload-btn" onclick="document.getElementById('file-input').click()">Choose Image</button>
        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileSelect(event)">
      </div>
      <div class="synth-link" onclick="initSynthetic()">or try with a synthetic scene</div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden">
    <div class="loader"></div>
    <p style="margin-top:16px; font-size:13px; color:#666;" id="loading-text">Reconstructing scene...</p>
  </div>

  <!-- Main App -->
  <div id="app" style="display:none;">
    <div class="top-bar">
      <div style="display:flex;align-items:center;">
        <div class="brand">
          <div class="brand-mark">A</div>
          <div class="brand-text">AnchorStage <span>v2.0</span></div>
        </div>
        <div class="top-subtitle">Explore your set</div>
      </div>
      <div class="top-stats">
        <span id="stat-splats"></span>
        <span id="stat-recon"></span>
        <span id="stat-aspect"></span>
        <span id="stat-fps"></span>
      </div>
    </div>

    <div class="middle">
      <div class="viewport-wrap" id="viewport-wrap">
        <!-- Three.js / GaussianSplats3D renders here -->
        <div id="viewer-container"></div>

        <!-- HUD overlay on top of 3D viewport -->
        <div class="hud-overlay">
          <div class="crosshair" id="crosshair"></div>

          <div class="cam-hud" id="cam-hud">
            <div>X: <span id="hud-px">0.00</span>m &nbsp; Y: <span id="hud-py">0.00</span>m &nbsp; Z: <span id="hud-pz">0.00</span>m</div>
            <div>Pitch: <span id="hud-rx">0.0</span>&deg; &nbsp; Yaw: <span id="hud-ry">0.0</span>&deg;</div>
          </div>

          <div class="capture-btn" onclick="capturePhoto()">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/></svg>
            Capture <kbd style="background:#222;border:1px solid #333;border-radius:3px;padding:0 4px;font-size:10px;margin-left:2px;">C</kbd>
          </div>

          <div class="lens-hud">
            <span class="lens-label">Lens</span>
            <div class="lens-group">
              <button class="lens-btn" data-focal="24" onclick="setLens(24)">24mm</button>
              <button class="lens-btn active" data-focal="35" onclick="setLens(35)">35mm</button>
              <button class="lens-btn" data-focal="50" onclick="setLens(50)">50mm</button>
              <button class="lens-btn" data-focal="85" onclick="setLens(85)">85mm</button>
              <button class="lens-btn" data-focal="135" onclick="setLens(135)">135mm</button>
              <button class="lens-btn" data-focal="200" onclick="setLens(200)">200mm</button>
            </div>
          </div>

          <div class="sensitivity-hud" style="flex-direction:column;gap:4px;align-items:flex-end;">
            <div style="display:flex;align-items:center;gap:8px;">
              Pt Size <span id="pt-val">0.008</span>
              <input type="range" id="pt-size" min="0.002" max="0.025" step="0.001" value="0.008" oninput="updatePointSize(this.value)">
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              Sensitivity <span id="sens-val">1.0x</span>
              <input type="range" id="sensitivity" min="0.1" max="3" step="0.1" value="1.0" oninput="document.getElementById('sens-val').textContent=this.value+'x'; if(window._controls) window._controls.rotateSpeed=0.6*parseFloat(this.value)">
            </div>
          </div>

          <div class="fps-display" id="fps-display"></div>
        </div>
      </div>

      <div class="photos-sidebar">
        <div class="photos-title">Photos <span id="photo-count">0</span></div>
        <div id="photo-list">
          <div class="photos-empty">Press C to capture photos<br>from different angles</div>
        </div>
      </div>
    </div>

    <div class="shortcut-bar">
      <div class="shortcut"><kbd>Click+Drag</kbd> Look</div>
      <div class="shortcut"><kbd>Scroll</kbd> Zoom</div>
      <div class="shortcut"><kbd>[</kbd> <kbd>]</kbd> Lens</div>
      <div class="shortcut"><kbd>C</kbd> Capture Photo</div>
      <div class="shortcut"><kbd>H</kbd> HUD</div>
      <div class="shortcut"><kbd>+</kbd> <kbd>-</kbd> Sensitivity</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ===================== STATE =====================
    let renderer, threeScene, camera, controls, pointCloud;
    let sceneReady = false;
    let hudVisible = true;
    let focalMm = 35;
    let sceneAspect = 16/9;  // detected from uploaded image
    let imageSize = [1280, 720];
    const lensPresets = [24, 35, 50, 85, 135, 200];

    console.log('AnchorStage v2.0 loaded');

    // Expose to global for onclick handlers
    window.setLens = setLens;
    window.capturePhoto = capturePhoto;
    window.handleFileSelect = handleFileSelect;
    window.initSynthetic = initSynthetic;
    window.updatePointSize = updatePointSize;

    function updatePointSize(val) {
      document.getElementById('pt-val').textContent = parseFloat(val).toFixed(3);
      if (pointCloud) pointCloud.material.size = parseFloat(val);
    }

    // ===================== UPLOAD =====================
    const dropArea = document.getElementById('drop-area');
    dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('dragover'); });
    dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
    dropArea.addEventListener('drop', e => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) uploadFile(file);
    });

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) uploadFile(file);
    }

    async function uploadFile(file) {
      showLoading('Uploading image...');
      const form = new FormData();
      form.append('file', file);
      try {
        const res = await fetch('/api/upload', { method: 'POST', body: form });
        const data = await res.json();
        await onSceneReady(data);
      } catch (e) {
        console.error(e);
        alert('Upload failed: ' + e.message);
        hideLoading();
      }
    }

    async function initSynthetic() {
      showLoading('Generating synthetic scene...');
      try {
        const res = await fetch('/api/init', { method: 'POST' });
        const data = await res.json();
        await onSceneReady(data);
      } catch (e) {
        console.error(e);
        hideLoading();
      }
    }

    function showLoading(text) {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading-overlay').classList.remove('hidden');
    }
    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    // ===================== THREE.JS SETUP =====================
    function initThree() {
      const container = document.getElementById('viewer-container');
      const w = container.clientWidth;
      const h = container.clientHeight;

      renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
      renderer.setSize(w, h);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setClearColor(0x0a0a0a);
      container.appendChild(renderer.domElement);

      threeScene = new THREE.Scene();

      const fov = 2 * Math.atan(36 / (2 * focalMm)) * (180 / Math.PI);
      camera = new THREE.PerspectiveCamera(fov, w / h, 0.01, 100);
      // SHARP scene: x[-1.5,1.7], y[-0.7,0.7] (flipped), z[0.4,2.3]
      camera.position.set(0, 0, -0.2);
      camera.up.set(0, 1, 0);

      controls = new OrbitControls(camera, renderer.domElement);
      window._controls = controls;  // expose for HUD sliders
      controls.target.set(0, 0, 0.8);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;
      controls.rotateSpeed = 0.6;
      controls.zoomSpeed = 1.2;
      // Limit orbit to prevent losing the scene edges
      controls.maxPolarAngle = Math.PI * 0.85;  // don't go fully under
      controls.minPolarAngle = Math.PI * 0.15;  // don't go fully over
      controls.maxAzimuthAngle = Math.PI * 0.4;  // limit horizontal rotation
      controls.minAzimuthAngle = -Math.PI * 0.4;
      controls.maxDistance = 3.0;  // don't zoom too far out
      controls.minDistance = 0.1;
      controls.update();

      window.addEventListener('resize', () => {
        const w2 = container.clientWidth;
        const h2 = container.clientHeight;
        camera.aspect = w2 / h2;
        camera.updateProjectionMatrix();
        renderer.setSize(w2, h2);
      });
    }

    async function loadPointCloud() {
      const res = await fetch('/api/pointcloud.bin');
      if (!res.ok) throw new Error(`Server returned ${res.status}: ${await res.text()}`);
      const arrayBuf = await res.arrayBuffer();
      const countView = new Uint32Array(arrayBuf, 0, 1);
      const n = countView[0];
      console.log(`Loading ${n.toLocaleString()} points into GPU...`);
      const floats = new Float32Array(arrayBuf, 4);
      const positions = new Float32Array(n * 3);
      const colors = new Float32Array(n * 3);
      for (let i = 0; i < n; i++) {
        positions[i * 3]     = floats[i * 6];
        positions[i * 3 + 1] = floats[i * 6 + 1];
        positions[i * 3 + 2] = floats[i * 6 + 2];
        colors[i * 3]        = floats[i * 6 + 3];
        colors[i * 3 + 1]    = floats[i * 6 + 4];
        colors[i * 3 + 2]    = floats[i * 6 + 5];
      }
      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
      geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
      const material = new THREE.PointsMaterial({
        size: parseFloat(document.getElementById('pt-size')?.value || 0.008),
        vertexColors: true,
        sizeAttenuation: true,
      });
      if (pointCloud) { threeScene.remove(pointCloud); pointCloud.geometry.dispose(); pointCloud.material.dispose(); }
      pointCloud = new THREE.Points(geometry, material);
      threeScene.add(pointCloud);
      console.log(`Point cloud loaded: ${n.toLocaleString()} points`);
    }

    // ===================== SCENE READY =====================
    async function onSceneReady(data) {
      document.getElementById('upload-screen').classList.add('hidden');
      document.getElementById('app').style.display = 'flex';

      // Detect aspect ratio from uploaded image
      if (data.image_size) {
        imageSize = data.image_size;
        sceneAspect = imageSize[0] / imageSize[1];
      }

      document.getElementById('stat-splats').textContent = data.num_splats.toLocaleString() + ' splats';
      document.getElementById('stat-recon').textContent = data.reconstruction_time_s + 's recon';
      document.getElementById('stat-aspect').textContent = imageSize[0] + 'Ã—' + imageSize[1];

      // The pointcloud.bin endpoint triggers SHARP processing on the server
      showLoading('Generating 3D scene via Apple SHARP... (30-90s first time)');

      if (!renderer) {
        await new Promise(r => setTimeout(r, 100));
        initThree();
      }

      try {
        await loadPointCloud();
        sceneReady = true;
        hideLoading();
        startRenderLoop();
      } catch (e) {
        console.error('Point cloud load failed:', e);
        hideLoading();
        alert('Failed to load 3D scene: ' + e.message);
      }
    }

    // ===================== RENDER LOOP =====================
    let animating = false;
    function startRenderLoop() {
      if (animating) return;
      animating = true;
      let frameCount = 0, lastFpsTime = performance.now();
      const loop = () => {
        if (!sceneReady) { animating = false; return; }
        requestAnimationFrame(loop);
        controls.update();
        renderer.render(threeScene, camera);

        frameCount++;
        const now = performance.now();
        if (now - lastFpsTime > 1000) {
          const fps = Math.round(frameCount * 1000 / (now - lastFpsTime));
          document.getElementById('stat-fps').textContent = fps + ' FPS';
          document.getElementById('fps-display').textContent = fps + ' fps';
          frameCount = 0;
          lastFpsTime = now;
        }
        if (camera) {
          document.getElementById('hud-px').textContent = camera.position.x.toFixed(2);
          document.getElementById('hud-py').textContent = camera.position.y.toFixed(2);
          document.getElementById('hud-pz').textContent = camera.position.z.toFixed(2);
        }
      };
      requestAnimationFrame(loop);
    }

    // ===================== LENS =====================
    function setLens(mm) {
      focalMm = mm;
      document.querySelectorAll('.lens-btn').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.focal) === mm);
      });
      if (camera) {
        camera.fov = 2 * Math.atan(36 / (2 * mm)) * (180 / Math.PI);
        camera.updateProjectionMatrix();
      }
    }
    function cycleLens(dir) {
      const idx = lensPresets.indexOf(focalMm);
      const next = Math.max(0, Math.min(lensPresets.length - 1, idx + dir));
      setLens(lensPresets[next]);
    }
    function adjustSensitivity(delta) {
      const el = document.getElementById('sensitivity');
      el.value = Math.max(0.1, Math.min(3, parseFloat(el.value) + delta)).toFixed(1);
      document.getElementById('sens-val').textContent = el.value + 'x';
      if (controls) controls.rotateSpeed = 0.6 * parseFloat(el.value);
    }

    // ===================== KEYBOARD =====================
    document.addEventListener('keydown', e => {
      if (e.key === 'h' || e.key === 'H') {
        hudVisible = !hudVisible;
        document.getElementById('cam-hud').style.display = hudVisible ? 'block' : 'none';
        document.getElementById('crosshair').style.display = hudVisible ? 'block' : 'none';
      }
      if (e.key === 'c' || e.key === 'C') capturePhoto();
      if (e.key === '[') cycleLens(-1);
      if (e.key === ']') cycleLens(1);
      if (e.key === '+' || e.key === '=') adjustSensitivity(0.1);
      if (e.key === '-' || e.key === '_') adjustSensitivity(-0.1);
    });

    // ===================== CAPTURE =====================
    async function capturePhoto() {
      if (!sceneReady || !renderer) return;
      const canvas = renderer.domElement;
      const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
      const photoCount = document.getElementById('photo-list').querySelectorAll('.photo-thumb').length + 1;
      document.getElementById('photo-count').textContent = photoCount;
      const list = document.getElementById('photo-list');
      if (photoCount === 1) list.innerHTML = '';
      const img = document.createElement('img');
      img.className = 'photo-thumb';
      img.src = dataUrl;
      img.title = 'Photo ' + photoCount;
      list.prepend(img);
    }
  </script>
</body>
</html>
